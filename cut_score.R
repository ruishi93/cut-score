library("TAM")
# ??????cs, ss, fix??????
# cs ?????????DSR??????50?????????DSR??????50????????????fixed??????????????? ???50????????????ss???????????????
# ss ?????????DSR?????????50?????????50????????????cut score???????????????????????? ??????50?????????DSR???????????????fixed??????
good_cs <- read.csv('shirui/ALO7/yuting_cutScore/data/good_cs.csv')
good_cs <- good_cs[,-1]
good_ss <- read.csv('shirui/ALO7/yuting_cutScore/data/good_ss.csv')
good_ss <- good_ss[,-1]
fixed_diff <- read.csv('shirui/ALO7/yuting_cutScore/data/fix_diff.csv')
fixed_diff$deltaj1

# ??????fix
# ??????index????????????????????????
xsi.fixed <- cbind(c(51:100), fixed_diff$deltaj1)
xsi.fixed


# test cs
# ????????? ??? reliability??????????????????
test_mod <- TAM::tam.mml(good_cs, irtmodel = "1PL", xsi.fixed = xsi.fixed)
test_mod$xsi$xsi
test_mod$EAP.rel

# test ss
test_mod_ss <- TAM::tam.mml(good_ss[,c(1:50,2551:2600)], irtmodel = "1PL", xsi.fixed = xsi.fixed)
test_mod_ss$xsi$xsi[1:50]
test_mod_ss$EAP.rel

# ??????????????????
# ------------------------------------------------------------------------------------------------
# ??????fix
xsi.fixed <- cbind(c(51:100), fixed_diff$deltaj1)
xsi.fixed

# cs??????fix??????????????? ??? reliability
cs_mod <- TAM::tam.mml(good_cs, irtmodel = "1PL", xsi.fixed = xsi.fixed)
cs_diff <- cs_mod$xsi$xs[1:50]
cs_reliability <- cs_mod$EAP.rel

# ??????cutscore??????ss???fix????????? ??? reliability
# ???50????????????????????????????????????cut score??????item difficulty
ss_diff <- list()
ss_reliability <- list()
for (i in seq(1,2550)){
  if (i %% 50 == 1){
    temp_mod <- TAM::tam.mml(good_ss[,c(i:(i+49),2551:2600)], irtmodel = "1PL", xsi.fixed = xsi.fixed)
    ss_diff <- append(ss_diff, temp_mod$xsi$xsi[1:50])
    ss_reliability <- append(ss_reliability, temp_mod$EAP.rel)
  }
}

# ??????
df_ss_diff <- data.frame(index=c(1:2550), diff=as.numeric(ss_diff))
df_cs_diff <- data.frame(index=c(2551:2600), diff=as.numeric(cs_diff))
df_all_diff <- rbind(df_ss_diff, df_cs_diff)

df_ss_rel <- data.frame(index=c(1:51), rel=as.numeric(ss_reliability))
df_cs_rel <- data.frame(index=c(52), rel=as.numeric(cs_reliability))
df_all_rel <- cbind(df_ss_rel, df_cs_rel)


# ??????
write.table(df_all_diff, file='shirui/ALO7/yuting_cutScore/data/result/good_diff.csv')
write.table(df_all_rel, file='shirui/ALO7/yuting_cutScore/data/result/good_rel.csv')

# ??????????????????
# ??????????????????????????????????????????
# --------------------------------------------------------------------------------------------------------
all_cs <- read.csv('shirui/ALO7/yuting_cutScore/data/all_cs.csv')
all_cs <- all_cs[,-1]
all_ss <- read.csv('shirui/ALO7/yuting_cutScore/data/all_ss.csv')
all_ss <- all_ss[,-1]
all_fixed_diff <- read.csv('shirui/ALO7/yuting_cutScore/data/all_fix_diff.csv')
all_fixed_diff$deltaj1

# ??????fix
xsi.fixed <- cbind(c(51:100), all_fixed_diff$deltaj1)
xsi.fixed

# test cs
# ????????? ??? reliability??????????????????
test_mod <- TAM::tam.mml(all_cs, irtmodel = "1PL", xsi.fixed = xsi.fixed)
test_mod$xsi$xsi
test_mod$EAP.rel

# test ss
test_mod_ss <- TAM::tam.mml(all_ss[,c(1:50,2551:2600)], irtmodel = "1PL", xsi.fixed = xsi.fixed)
test_mod_ss$xsi$xsi[1:50]
test_mod_ss$EAP.rel



# cs??????fix??????????????? ??? reliabiliyt
all_cs_mod <- TAM::tam.mml(all_cs, irtmodel = "1PL", xsi.fixed = xsi.fixed)
all_cs_diff <- all_cs_mod$xsi$xs[1:50]
all_cs_reliability <- all_cs_mod$EAP.rel

# ??????cutscore??????ss???fix????????? ??? reliability
all_ss_diff <- list()
all_ss_reliability <- list()
for (i in seq(1,2550)){
  if (i %% 50 == 1){
    temp_mod <- TAM::tam.mml(all_ss[,c(i:(i+49),2551:2600)], irtmodel = "1PL", xsi.fixed = xsi.fixed)
    all_ss_diff <- append(all_ss_diff, temp_mod$xsi$xsi[1:50])
    all_ss_reliability <- append(all_ss_reliability, temp_mod$EAP.rel)
  }
}

# ??????
df_ss_diff_all <- data.frame(index=c(1:2550), diff=as.numeric(all_ss_diff))
df_cs_diff_all <- data.frame(index=c(2551:2600), diff=as.numeric(all_cs_diff))
df_all_diff_all <- rbind(df_ss_diff_all, df_cs_diff_all)

df_ss_rel_all <- data.frame(index=c(1:51), rel=as.numeric(all_ss_reliability))
df_cs_rel_all <- data.frame(index=c(52), rel=as.numeric(all_cs_reliability))
df_all_rel_all <- cbind(df_ss_rel_all, df_cs_rel_all)

# ??????
write.table(df_all_diff_all, file='shirui/ALO7/yuting_cutScore/data/result/all_diff.csv')
write.table(df_all_rel_all, file='shirui/ALO7/yuting_cutScore/data/result/all_rel.csv')
